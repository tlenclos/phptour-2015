<!DOCTYPE HTML>
<html lang="en">
<head>
	<title>Retour d'expérience, ARTE API</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=792, user-scalable=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<link rel="stylesheet" href="shower/themes/ribbon/styles/screen.css">
	<link rel="stylesheet" href="styles/prism.css" />
	<link rel="stylesheet" href="styles/custom.css">
</head>
<body class="list">
	<header class="caption">
		<h1>Retour d'expérience, ARTE API</h1>
		<p>PHP Tour Luxembourg - Lenclos Thibault - 2015</p>
	</header>
	<section class="slide cover" id="coverpage"><div>
		<img src="pictures/cover-luxembourg.jpg" />
		<div class="covertitle">
			<h2>Retour d'expérience, ARTE API</h2>
			<p>PHP Tour Luxembourg - Thibault Lenclos - <span class="date">2015</span></p>
		</div>
	</div></section>
	<section class="slide"><div>
		<h2>Je suis</h2>
		<div>
			<img src="pictures/twitter1.png" style="height: 17em;" />
			<img src="pictures/meme.jpg" style="height: 13em;" />
		</div>
	<footer>Devenu un meme après 4 retweet d’un photomontage douteux</footer>
	</div></section>
	<section class="slide"><div>
		<h2>En vrai : Thibault Lenclos - @thibz</h2>
		<p>Dév Web et mobile @jolicode<br />

			PHP (Symfony2), JS full stack (node, meteor), mobile (titanium)<br />

			Rock & code<br />

			<img src="pictures/metal.gif" />
		</p>
		<footer>Jeune développeur, je risque d’être émerveillé par des choses plutôt courante mais je tiens à les retranscrire dans cette conférence
			Passionné, j’assimile souvent le développement à la musique, en terme de composition et rigeur.</footer>
	</div></section>
	<section class="slide"><div>
		<h2>Sommaire</h2>
		<ol>
			<li>Arte</li>
			<li>Projet</li>
			<li>Outils et processus</li>
			<li>Bilan</li>
		</ol>
	</div></section>
	<section class="slide"><div>
		<h2>Arte</h2>
		<p>ARTE GEIE, basé à Strasbourg<br />

			Chaîne de télévision franco-allemande<br />

			Nombreuses plateformes (TV, Web, mobile, HBBTV…)
		</p>
	</div></section>
	<section class="slide"><div>
		<h2>Équipe</h2>
		<p class="nomargin">François Dume (conférence Forum PHP 2014) et Matthieu Breen.</p>
		<img src="pictures/collaborateurs.png" style="height: 17em;" />
		<footer>François, dév ops, supervise le développement.
			Matthieu, product manager, documentation.
			Proposer la conf de François pour ce qui est des spécificités REST (Hateoas, Json API, architecture) + point de vue client.
		</footer>
	</div></section>
	<section class="slide cover"><div>
		<h2>Projet : API et portail partenaire</h2>
		<img src="pictures/portail-partenaire-doc.png">
	</div></section>
	<section class="slide"><div>
		<h2>Projet : API</h2>
		<p>Nouvelle API Rest, données unifiées<br />

			OAuth 2<br />

			Proxy Nginx + scripts Lua (rate limit et authentification)
		</p>
		<footer>Insister sur les spécificité d’un projet API
			- Tests
			- Qualité
			- Impacts sur différents clients
		</footer>
	</div></section>
	<section class="slide"><div>
		<h2>Projet : portail partenaire</h2>
		<p><img src="pictures/portail-partenaire-app.png" />
		</p>
		<footer>Gérer les utilisateurs de l’API
			Création d’application, de tokens, association à des organisations et accès à la documentation
		</footer>
	</div></section>
	<section class="slide cover"><div>
		<h2>Organisation</h2>
		<img src="pictures/aoshima-cat-island-japan.jpg ">
		<footer>J'ai listé quelques points concernant l'organisation, peut être évident pour la plupart d'entre vous mais je n’avais pas ces habitude de travail. Elles font maintenant parti de mon quotidien.</footer>
	</div></section>
	<section class="slide"><div>
		<h2>Organisation (1)</h2>
		<p>Stand-up chaque matin<br/>

			Priorisation des tâches<br/>

			“Fix bug first”<br/>

			Mise en production hebdomadaire (et simple !)<br/>

			Communication chat et VOIP
		</p>
		<footer>
			Nouvelle méthodologie de travail, interactions fréquentes entre les développeurs et le responsable des features, points réguliers
			Les mises en production hebdomadaire permettent de rajouter de la valeur au produit rapidement, j'ai connu des mises en production avec des scripts "à la main" et l'on croisait les doigts avant d'appuyer sur le bouton
			Toute l’équipe est joignable tout le temps, très peu d’attente pour les dialogues, au revoir le mail !
		</footer>
	</div></section>
	<section class="slide"><div>
		<h2>Organisation (2)</h2>

		<div style="float: right; width: 50%;">
			<img src="pictures/watching.gif" />
		</div>
		<p><strong>Github</strong> : Pull request et revue de code<br />

			<strong>Jira</strong> : gestion de tickets<br />

			<strong>Bamboo</strong> : intégration continue<br />

			<strong>Hipchat</strong> : chat + notifications diverses (PR, déploiement, fail des tests)<br />

			<strong>Digital ocean</strong> : création de VM à la volée
		</p>
		<footer>revue de code : assure la qualité, évite des bugs et permet à l’ensemble de l’équipe de prendre la main sur le code produit
		VM pour le build et les tests unitaires / fonctionnels
		</footer>
	</div></section>
	<section class="slide"><div>
		<h2>Workflow</h2>
		<p>Même environnement pour tous :</p>
		<ul>
			<li>Vagrant : machine virtuelle</li>

			<li>Ansible : provisionning versionné de la machine</li>

			<li>Packer : accélérer l’arrivée d’un collaborateur sur le projet, la construction de VM de test</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Architecture</h2>
		<img src="pictures/architecture-api.png" style="height: 16em;" />
	</div></section>
	<section class="slide"><div>
		<h2>Standard pour l'API</h2>
		<p>API : JSON API<br />
			Documentation : Swagger</p>
	</div></section>
	<section class="slide"><div>
		<img src="pictures/json-api.png" style="width: 57%; display: block; margin: auto" />
	</div></section>
	<section class="slide"><div>
		<h2>Autres formats</h2>
		<p>JSON-LD : schéma et lien<br />
		Hydra : schéma et documentation directement dans la réponse</p>

		<p>(voir <a href="https://github.com/dunglas/api-platform">https://github.com/dunglas/api-platform</a>)</p>

		<footer>Kévin Dunglas à réalisé une conférence sur ces derniers format au dernier symfony live</footer>
	</div></section>


	<section class="slide"><div>
		<h2>REST</h2>
		<p>Basé sur le standard JSON Api :</p>

		<ul>
			<li>includes</li>
			<li>fields</li>
			<li>links</li>
		</ul>

		<p>semantic versionning (non défini dans le standard)</p>
		<footer>Utilisation de https://github.com/willdurand/BazingaHateoasBundle pour les liens hypermédia</footer>
	</div></section>
	<section class="slide" id="documentation"><div>
		<h2>Documentation</h2>
		<img src="pictures/portail-partenaire-doc.png" />
		<footer>Regroupement de la documentation pour toutes les API

			Ajout de documentation markdown associé aux ressources

			Sandbox plus complète (version api, type de client)
		</footer>
	</div></section>
	<style>
		#documentation img {
			max-width: 104%;
		}
	</style>
	<section class="slide"><div>
		<h2>Openresty</h2>
		<p>Nginx + modules<br />

			Étendre le serveur avec des scripts<br />

			Interagir avec des bases de données (ex: cache redis)<br />

			Sous-requêtes
		</p>
		<footer>Proxy, gère les accès aux API, sous requête avec OAuth</footer>
	</div></section>
	<section class="slide"><div>
		<h2>Scripts LUA</h2>
		<p>
			Typage dynamique<br />

			Apprentissage rapide<br />

			Interviennent à différents moments de la requête
		</p>
		<footer>Plutôt simple à appréhender, il faut traiter le serveur comme une application => tests</footer>
	</div></section>
	<section class="slide"><div>
		<h2>Test des scripts LUA</h2>
		<p class="nomargin">Testable via le package perl Test:Nginx<br />

			<pre><code class="language-javascript">	--- http_config
	lua_shared_dict cache 10M;
	--- config
	location /test-401 {
		header_filter_by_lua_file /etc/nginx/conf.d/oauth-header-filter.lua;
		access_by_lua_file /etc/nginx/conf.d/oauth-throttle.lua;
	}
	--- request
	GET /test-401
	--- error_code: 401</code></pre>

			Difficulté de tester unitairement => tests fonctionnels
		</p>
		<footer>Difficulté de tester unitairement
			Tests fonctionnels avec frisby par la suite
		</footer>
	</div></section>
	<section class="slide" id="tests-fonctionnels"><div>
		<h2>Tests fonctionnels</h2>
		<p class="nomargin">SF2 (WebTestCase)<br>

		Frisby JS (maintenu par Vance Lucas)</p>

		<pre><code class="language-javascript">frisby.create('Check token generation')
.get(oauthTokenUrl)
.expectStatus(200)
.expectHeaderContains('content-type', 'application/json')
.afterJSON(function(json) {
	var accessToken = json.access_token;

	frisby.create('Check invalid token returns a 401')
	.get(apiBaseUrl + '/api/videps?access_token=invalidToken')
	.expectStatus(401)
	.expectMaxResponseTime(maxResponseTimeExpected)
	.toss();
});
		</code></pre>
		<footer>Vances Lucas : dotenv, librairie simple</footer>
	</div></section>
	<style>
		#tests-fonctionnels pre code {
			line-height: 24px;
		}
	</style>
	<section class="slide"><div>
		<h2>Benchmark performance</h2>
		<p>Tsung => tests de stress<br>

		JMeter => tests de performance<br>

		Blackfire</p>
		<footer>Tsung, définition de phase avec augmentation du nombre d’utilisateurs sur le temps
			Blackfire nous a permit de trouver les éléments les moins performants (serialization, requêtes)
		</footer>
	</div></section>
	<section class="slide"><div>
		<h2>Bundles Symfony2</h2>
		<p>REST<br>
			nelmio/api-doc-bundle<br>
			friendsofsymfony/rest-bundle<br>
			jms/serializer<br>
			arte/hateoas-bundle (POC)<br>

			TESTS<br>
			liip/functional-test-bundle
		</p>
		<footer>hateoas-bundle, répond aux problématique de performance mais peu maintenable (génération de code)
		A voir avec le serializer SF2.7
		</footer>
	</div></section>
	<section class="slide"><div>
		<h2>Docker</h2>
		<p>Utilisation d’un makefile pour certaines tâches de développement :</p>

		<ul>
			<li>mise en production (capistrano)</li>
			<li>composer</li>
			<li>phpunit</li>
		</ul>

		<p>
			Merci Marmelab !<br>
			<a href="https://github.com/marmelab/make-docker-command">https://github.com/marmelab/make-docker-command</a>
		</p>
	</div></section>
	<section class="slide"><div>
		<h2>Ansible</h2>
		<p>Description des paquets, fichiers de confs...<br>

			Exécution de tâches<br>

			Ex: relancer nginx avec mise à jour des scripts LUA
		</p>

		<pre><code class="language-javascript">name: write the oauth-throttle.lua file for api-proxy
copy: src=oauth-throttle.lua dest=/etc/nginx/conf.d/oauth-throttle.lua backup=no
notify:
- restart nginx
tags:
- proxy-api
- nginx</code></pre>
	</div></section>
	<section class="slide"><div>
		<h2>Monitoring</h2>
		<p>New relic + logstash (gelf et syslog)<br>

			<img src="pictures/logs.png" />
		</p>
		<footer>
			Alerte avec les exceptions
			Identification des types de client (mobile, tv…), de la charge
		</footer>
	</div></section>
	<section class="slide"><div>
		<h2>Clients actuels de l'API</h2>
		<ul>
			<li>Arte Concert</li>
			<li>Arte Future</li>
			<li>Arte Creative</li>
			<li>Arte Cinema</li>
			<li>Applications mobiles Concert/Creative/Future,</li>
			<li>Applications TV</li>
			<li>Apple TV</li>
			<li>Arte concert</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Open source (presque !)</h2>
		<p>"Parce qu'on est des poules mouillées" - MB<br />
			Suppression des données sensibles<br>
			<a href="https://github.com/rtyley/bfg-repo-cleaner">BFG repo cleaner</a>
		</p>
	</div></section>
	<section class="slide"><div>
		<h2>À venir</h2>
		<p>SDK pour les partenaires<br>

			Migration des clients utilisant l’ancienne version de l’API (PAPI)<br>

			PHP 7 - Elasticsearch
		</p>
	</div></section>
	<section class="slide"><div>
		<h2>Bilan personnel</h2>
		<p>Premier projet @jolicode<br>

			Très formateur<br>

			Développement proche de l’architecture<br>

			Nouvelles méthodologies
		</p>
		<footer>
			Responsabiliser les développeurs
			Approche dev ops
		</footer>
	</div></section>
	<section class="slide"><div>
		<h2>Bilan projet</h2>
		<p>Métier connu<br>

			Problématique de performance<br>

			Choix des outils
		</p>
		<footer>Le métier étant connu, la gestion de projet est simplifié. Les problèmes ont été au niveau du développement, notamment problèmes de performances.

			L'ensemble de ces outils a permis d'assurer un bon niveau de qualité de l'API, nous allons continuer à travailler pour Arte pour les futures évolutions.

			L’extension de hateoas à répondu au problème mais n’est pas maintenable de par son mécanisme de génération de code. Cette partie va surement évoluer grâce aux récentes améliorations du serializer SF2.

			Merci de votre attention, si vous avez des questions où discuter après la conférence, n’hésitez pas.
		</footer>
	</div></section>
	<section class="slide"><div>
		<h2>Merci \o/</h2>
		<ul>
			<li>Twitter <a href="twitter.com/thibz">@thibz</a></li>
			<li>Github <a href="github.com/tlenclos">@tlenclos</a></li>
		</ul>
		<p style="font-size: 2em">Questions ?</p>
	</div></section>
	<section class="slide"><div>
		<h2>Ressources</h2>
		<p><a href="http://jsonapi.org/">JSON Api</a><br>

			<a href="http://openresty.org/">Openresty</a><br>

			<a href="http://www.ansible.com">Ansible</a><br>

			<a href="https://github.com/ArteGEIE/ArteHateoasBundle">ArteGEIE/ArteHateoasBundle</a><br>

			<a href="https://github.com/ArteGEIE/docker-images">ArteGEIE/docker-images</a>
		</p>
	</div></section>
	<div class="progress"><div></div></div>
	<script src="shower/shower.min.js"></script>
	<script src="styles/prism.js"></script>
	<script src="styles/jquery-2.1.1.min.js"></script>
	<script src="styles/progress.js"></script>
	<!-- Copyright © 2014 Yours Truly, Famous Inc. -->
	<!-- Photos by John Carey, fiftyfootshadows.net -->
</body>
</html>
